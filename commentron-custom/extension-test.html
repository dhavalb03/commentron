<!DOCTYPE html>
<html>
<head>
    <title>Extension Communication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; }
        button { margin: 10px 0; padding: 10px 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Extension Communication Test</h1>
        
        <p>This test helps diagnose extension communication issues on LinkedIn pages.</p>
        
        <button onclick="testExtensionCommunication()">Test Extension Communication</button>
        <button onclick="testBackgroundScript()">Test Background Script</button>
        <button onclick="checkExtensionStatus()">Check Extension Status</button>
        
        <div id="result"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML += `<div class="result ${type}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('result').innerHTML = '';
        }
        
        async function checkExtensionStatus() {
            clearLog();
            log('Checking extension status...');
            
            try {
                // Check if chrome.runtime is available
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    log('❌ Chrome runtime not available - extension not loaded or context invalid', 'error');
                    return;
                }
                
                log('✅ Chrome runtime available');
                
                // Check if we can get extension info
                try {
                    const manifest = chrome.runtime.getManifest();
                    log(`✅ Extension loaded: ${manifest.name} v${manifest.version}`, 'success');
                } catch (e) {
                    log('❌ Cannot access extension manifest: ' + e.message, 'error');
                }
                
                // Check if background script is responsive
                try {
                    chrome.runtime.sendMessage({action: 'ping'}, (response) => {
                        if (chrome.runtime.lastError) {
                            log('❌ Background script not responding: ' + chrome.runtime.lastError.message, 'error');
                        } else {
                            log('✅ Background script responsive', 'success');
                        }
                    });
                } catch (e) {
                    log('❌ Error pinging background script: ' + e.message, 'error');
                }
                
            } catch (error) {
                log('❌ Extension status check failed: ' + error.message, 'error');
            }
        }
        
        async function testBackgroundScript() {
            clearLog();
            log('Testing background script communication...');
            
            try {
                if (!chrome.runtime) {
                    log('❌ Chrome runtime not available', 'error');
                    return;
                }
                
                const testData = {
                    action: 'generateComment',
                    postData: {
                        content: 'Test post content for background script',
                        author: 'Test Author',
                        url: window.location.href
                    },
                    settings: {
                        geminiApiKey: 'test-key',
                        commentLength: 'brief',
                        tone: 'professional',
                        industry: 'technology'
                    }
                };
                
                log('Sending test message to background script...');
                
                chrome.runtime.sendMessage(testData, (response) => {
                    if (chrome.runtime.lastError) {
                        log('❌ Communication failed: ' + chrome.runtime.lastError.message, 'error');
                    } else if (response && response.error) {
                        log('✅ Communication successful, got error response: ' + response.error, 'info');
                    } else if (response && response.comment) {
                        log('✅ Communication successful, got comment: ' + response.comment, 'success');
                    } else {
                        log('⚠️ Communication successful but unexpected response: ' + JSON.stringify(response), 'info');
                    }
                });
                
            } catch (error) {
                log('❌ Test failed: ' + error.message, 'error');
            }
        }
        
        async function testExtensionCommunication() {
            clearLog();
            log('Testing full extension communication flow...');
            
            try {
                // First check if we're on LinkedIn
                if (!window.location.href.includes('linkedin.com')) {
                    log('⚠️ Not on LinkedIn - open this on a LinkedIn page for full testing', 'info');
                }
                
                // Check for CommenTron content script
                if (window.commentronInitialized) {
                    log('✅ CommenTron content script is initialized', 'success');
                } else {
                    log('❌ CommenTron content script not found', 'error');
                }
                
                // Check for LinkedIn comment buttons
                const commentButtons = document.querySelectorAll('.artdeco-button__text');
                log(`Found ${commentButtons.length} artdeco-button__text elements`);
                
                let actualCommentButtons = 0;
                commentButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes('comment')) {
                        actualCommentButtons++;
                    }
                });
                
                log(`Found ${actualCommentButtons} actual comment buttons`);
                
                // Check for comment text editors
                const commentEditors = document.querySelectorAll('.comments-comment-box-comment__text-editor');
                log(`Found ${commentEditors.length} comment text editors`);
                
                if (actualCommentButtons > 0 && commentEditors.length > 0) {
                    log('✅ LinkedIn comment infrastructure detected', 'success');
                } else {
                    log('⚠️ Limited LinkedIn comment infrastructure detected', 'info');
                }
                
            } catch (error) {
                log('❌ Extension test failed: ' + error.message, 'error');
            }
        }
        
        // Auto-run status check on load
        window.addEventListener('load', () => {
            setTimeout(checkExtensionStatus, 1000);
        });
    </script>
</body>
</html>